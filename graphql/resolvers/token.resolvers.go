package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.62

import (
	"context"
	"fmt"

	"github.com/polatbilal/gqlgen-ent/ent"
	"github.com/polatbilal/gqlgen-ent/ent/companydetail"
	"github.com/polatbilal/gqlgen-ent/ent/companytoken"
	"github.com/polatbilal/gqlgen-ent/graphql/generated"
	"github.com/polatbilal/gqlgen-ent/graphql/model"
	"github.com/polatbilal/gqlgen-ent/middlewares"
)

// CompanyCode is the resolver for the CompanyCode field.
func (r *companyTokenResolver) CompanyCode(ctx context.Context, obj *ent.CompanyToken) (*int, error) {
	company, err := obj.QueryCompany().Only(ctx)
	if err != nil {
		if ent.IsNotFound(err) {
			return nil, nil
		}
		return nil, fmt.Errorf("şirket bilgisi alınamadı: %v", err)
	}

	return &company.CompanyCode, nil
}

// UpsertToken, token yoksa oluşturur varsa günceller
func (r *mutationResolver) UpsertToken(ctx context.Context, departmentID int, input model.CompanyTokenInput) (*ent.CompanyToken, error) {
	client := middlewares.GetClientFromContext(ctx)

	// Yetkili kullanıcıyı kontrol et
	if userRole := middlewares.CtxValue(ctx); userRole == nil || userRole.Role != "Admin" {
		return nil, fmt.Errorf("yetkiniz yok")
	}

	// Önce token'ı kontrol et
	existingToken, err := client.CompanyToken.Query().Where(companytoken.DepartmentIdEQ(departmentID)).Only(ctx)
	if err != nil {
		if ent.IsNotFound(err) {
			// Token bulunamadı, yeni token oluştur
			// 1. Önce token'ı kaydet
			tokenCreate := client.CompanyToken.Create().
				SetYDKUsername(*input.YDKUsername).
				SetYDKPassword(*input.YDKPassword).
				SetToken(*input.Token).
				SetDepartmentId(departmentID)
			createCompanyToken, err := tokenCreate.Save(ctx)
			if err != nil {
				return nil, fmt.Errorf("şirket token oluşturulamadı: %v", err)
			}

			company, err := client.CompanyDetail.Create().
				SetName(*input.CompanyInput.Name).
				SetCompanyCode(*input.CompanyInput.CompanyCode).
				SetNillableAddress(input.CompanyInput.Address).
				SetNillablePhone(input.CompanyInput.Phone).
				SetNillableFax(input.CompanyInput.Fax).
				SetNillableMobilePhone(input.CompanyInput.MobilePhone).
				SetNillableEmail(input.CompanyInput.Email).
				SetNillableWebsite(input.CompanyInput.Website).
				SetNillableTaxAdmin(input.CompanyInput.TaxAdmin).
				SetNillableTaxNo(input.CompanyInput.TaxNo).
				SetNillableChamberInfo(input.CompanyInput.ChamberInfo).
				SetNillableChamberRegisterNo(input.CompanyInput.ChamberRegisterNo).
				SetNillableVisaDate(input.CompanyInput.VisaDate).
				SetNillableVisaEndDate(input.CompanyInput.VisaEndDate).
				SetNillableVisaFinishedFor90Days(input.CompanyInput.VisaFinishedFor90days).
				SetNillableCorePersonAbsent90Days(input.CompanyInput.CorePersonAbsent90days).
				SetNillableIsClosed(input.CompanyInput.IsClosed).
				SetNillableOwnerName(input.CompanyInput.OwnerName).
				SetNillableOwnerTcNo(input.CompanyInput.OwnerTcNo).
				SetNillableOwnerAddress(input.CompanyInput.OwnerAddress).
				SetNillableOwnerPhone(input.CompanyInput.OwnerPhone).
				SetNillableOwnerEmail(input.CompanyInput.OwnerEmail).
				SetNillableOwnerRegisterNo(input.CompanyInput.OwnerRegisterNo).
				SetNillableOwnerCareer(input.CompanyInput.OwnerCareer).
				Save(ctx)

			if err != nil {
				fmt.Printf("Şirket oluşturma hatası: %v\n", err)
				return createCompanyToken, nil
			}

			fmt.Printf("Şirket başarıyla oluşturuldu: ID=%d\n", company.ID)

			// 4. Token ile şirketi ilişkilendir
			if _, err := createCompanyToken.Update().
				SetCompany(company).
				Save(ctx); err != nil {
				fmt.Printf("Token ile şirket ilişkilendirilemedi: %v\n", err)
			}

			// Kullanıcı ID'sini context'ten al
			claims := middlewares.CtxValue(ctx)
			userID := claims.ID

			// CompanyUser ilişkisini oluştur
			_, err = client.CompanyUser.Create().
				SetCompanyID(company.ID).
				SetUserID(userID).
				Save(ctx)
			if err != nil {
				fmt.Printf("Kullanıcı-şirket ilişkisi oluşturulamadı: %v\n", err)
			}

			return createCompanyToken, nil
		}
		return nil, fmt.Errorf("token sorgulama hatası: %v", err)
	}

	// Token bulunduysa güncelle
	updatedCompanyToken, err := existingToken.Update().
		SetToken(*input.Token).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("şirket token güncellenemedi: %v", err)
	}

	return updatedCompanyToken, nil
}

// CompanyToken is the resolver for the companyToken field.
func (r *queryResolver) CompanyToken(ctx context.Context, companyCode *int) (*ent.CompanyToken, error) {
	client := middlewares.GetClientFromContext(ctx)

	fmt.Println("companyCode", companyCode)

	// Önce departmentId olarak deneyelim
	companyToken, err := client.CompanyToken.Query().
		Where(companytoken.DepartmentIdEQ(*companyCode)).
		Only(ctx)
	if err != nil {
		if !ent.IsNotFound(err) {
			return nil, fmt.Errorf("token sorgulama hatası: %v", err)
		}

		// DepartmentId ile bulunamadıysa, companyCode ile arama yapalım
		company, err := client.CompanyDetail.Query().Where(companydetail.CompanyCodeEQ(*companyCode)).Only(ctx)
		if err != nil {
			return nil, fmt.Errorf("şirket bulunamadı: %v", err)
		}

		// CompanyCode ile şirket bulunduysa, token'ı getirelim
		companyToken, err := company.QueryTokens().Only(ctx)
		if err != nil {
			return nil, fmt.Errorf("şirket token bulunamadı: %v", err)
		}
		return companyToken, nil
	}

	return companyToken, nil
}

// CompanyToken returns generated.CompanyTokenResolver implementation.
func (r *Resolver) CompanyToken() generated.CompanyTokenResolver { return &companyTokenResolver{r} }

type companyTokenResolver struct{ *Resolver }
