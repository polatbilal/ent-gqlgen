package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.74

import (
	"context"
	"fmt"
	"strconv"
	"strings"

	"github.com/polatbilal/ent-gqlgen/ent"
	"github.com/polatbilal/ent-gqlgen/ent/jobdetail"
	"github.com/polatbilal/ent-gqlgen/ent/jobfloor"
	"github.com/polatbilal/ent-gqlgen/ent/jobrelations"
	"github.com/polatbilal/ent-gqlgen/graphql/generated"
	"github.com/polatbilal/ent-gqlgen/graphql/model"
	"github.com/polatbilal/ent-gqlgen/middlewares"
)

// Job is the resolver for the Job field.
func (r *jobFloorResolver) Job(ctx context.Context, obj *ent.JobFloor) (*ent.JobDetail, error) {
	client := middlewares.GetClientFromContext(ctx)
	relations, err := client.JobRelations.Query().
		Where(jobrelations.HasFloorsWith(jobfloor.IDEQ(obj.ID))).
		Only(ctx)
	if err != nil {
		return nil, err
	}
	return relations.QueryJob().Only(ctx)
}

// CreateFloor is the resolver for the createFloor field.
func (r *mutationResolver) CreateFloor(ctx context.Context, input model.JobFloorInput) (*ent.JobFloor, error) {
	client := middlewares.GetClientFromContext(ctx)

	uppercaseName := strings.ToUpper(*input.Name)

	floor, err := client.JobFloor.Create().
		SetYibfNo(*input.YibfNo).
		SetName(uppercaseName).
		SetMetre(*input.Metre).
		SetNillableMoldDate(input.MoldDate).
		SetNillableConcreteDate(input.ConcreteDate).
		SetNillableSamples(input.Samples).
		SetNillableConcreteClass(input.ConcreteClass).
		SetNillableWeekResult(input.WeekResult).
		SetNillableMonthResult(input.MonthResult).
		Save(ctx)
	if err != nil {
		return nil, err
	}

	// JobRelations'ı bul
	relations, err := client.JobRelations.Query().Where(jobrelations.YibfNoEQ(*input.YibfNo)).Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("iş ilişkileri bulunamadı: %v", err)
	}

	// Floor'u JobRelations'a ekle
	_, err = relations.Update().
		AddFloors(floor).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("katman iş ilişkilerine eklenemedi: %v", err)
	}

	return floor, nil
}

// UpdateFloor is the resolver for the updateFloor field.
func (r *mutationResolver) UpdateFloor(ctx context.Context, id string, input model.JobFloorInput) (*ent.JobFloor, error) {
	client := middlewares.GetClientFromContext(ctx)

	floorID, err := strconv.Atoi(id)
	if err != nil {
		return nil, fmt.Errorf("failed to convert floor ID: %v", err)
	}

	// Update Floor
	floor, err := client.JobFloor.UpdateOneID(floorID).
		SetNillableName(input.Name).
		SetNillableMetre(input.Metre).
		SetNillableMoldDate(input.MoldDate).
		SetNillableConcreteDate(input.ConcreteDate).
		SetNillableSamples(input.Samples).
		SetNillableConcreteClass(input.ConcreteClass).
		SetNillableWeekResult(input.WeekResult).
		SetNillableMonthResult(input.MonthResult).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update floor: %v", err)
	}

	return floor, nil
}

// DeleteFloor is the resolver for the deleteFloor field.
func (r *mutationResolver) DeleteFloor(ctx context.Context, id string) (*ent.JobFloor, error) {
	client := middlewares.GetClientFromContext(ctx)

	// ID'yi string'den int'e dönüştür
	floorID, err := strconv.Atoi(id)
	if err != nil {
		return nil, fmt.Errorf("geçersiz ID formatı: %v", err)
	}

	// İş katmanını ID ile sorgula
	floor, err := client.JobFloor.Query().Where(jobfloor.IDEQ(floorID)).Only(ctx)
	if err != nil {
		if ent.IsNotFound(err) {
			return nil, fmt.Errorf("kayıt bulunamadı")
		}
		return nil, err
	}

	// İş katmanını sil
	err = client.JobFloor.DeleteOne(floor).Exec(ctx)
	if err != nil {
		return nil, fmt.Errorf("iş katmanı silinemedi: %v", err)
	}

	return floor, nil
}

// Floors is the resolver for the Floors field.
func (r *queryResolver) Floors(ctx context.Context, yibfNo int) ([]*ent.JobFloor, error) {
	client := middlewares.GetClientFromContext(ctx)
	query := client.JobFloor.Query()

	if yibfNo != 0 {
		// JobDetail -> JobRelations -> JobFloor ilişkisini kullan
		query = query.Where(
			jobfloor.HasFloorWith(
				jobrelations.HasJobWith(
					jobdetail.YibfNoEQ(yibfNo),
				),
			),
		)
	}

	floors, err := query.All(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to get floors: %v", err)
	}
	return floors, nil
}

// JobFloor returns generated.JobFloorResolver implementation.
func (r *Resolver) JobFloor() generated.JobFloorResolver { return &jobFloorResolver{r} }

type jobFloorResolver struct{ *Resolver }
