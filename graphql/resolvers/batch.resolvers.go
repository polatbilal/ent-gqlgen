package resolvers

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.62

import (
	"context"
	"fmt"
	"strings"

	"github.com/polatbilal/gqlgen-ent/ent"
	"github.com/polatbilal/gqlgen-ent/ent/companydetail"
	"github.com/polatbilal/gqlgen-ent/ent/jobcontractor"
	"github.com/polatbilal/gqlgen-ent/ent/jobdetail"
	"github.com/polatbilal/gqlgen-ent/ent/jobowner"
	"github.com/polatbilal/gqlgen-ent/ent/jobrelations"
	"github.com/polatbilal/gqlgen-ent/ent/jobsupervisor"
	"github.com/polatbilal/gqlgen-ent/graphql/helpers"
	"github.com/polatbilal/gqlgen-ent/graphql/model"
	"github.com/polatbilal/gqlgen-ent/middlewares"
)

// JobBatchMutation is the resolver for the jobBatchMutation field.
func (r *mutationResolver) JobBatchMutation(ctx context.Context, input model.JobBatchInput) (*model.JobBatchResult, error) {
	maxRetries := 3
	var lastErr error

	for attempt := 0; attempt < maxRetries; attempt++ {
		if attempt > 0 {
			fmt.Printf("Yeniden deneme %d/%d\n", attempt+1, maxRetries)
		}

		result, err := r.ExecuteBatchMutation(ctx, input)
		if err != nil {
			lastErr = err
			if strings.Contains(err.Error(), "duplicate key value violates unique constraint") {
				continue
			}
			return nil, err
		}
		return result, nil
	}

	return nil, fmt.Errorf("maksimum deneme sayısına ulaşıldı, son hata: %w", lastErr)
}

// ExecuteBatchMutation is the resolver for the executeBatchMutation field.
func (r *mutationResolver) ExecuteBatchMutation(ctx context.Context, input model.JobBatchInput) (*model.JobBatchResult, error) {
	client := middlewares.GetClientFromContext(ctx)
	if client == nil {
		return nil, fmt.Errorf("client nil")
	}

	tx, err := client.Tx(ctx)
	if err != nil {
		return nil, fmt.Errorf("transaction başlatılırken hata oluştu: %w", err)
	}

	defer func() {
		if v := recover(); v != nil {
			fmt.Printf("Panic oluştu: %v\n", v)
			_ = tx.Rollback()
			panic(v)
		}
	}()

	txCtx := ent.NewContext(ctx, tx.Client())

	// Mevcut JobRelations kaydını bul
	existingRelations, err := tx.JobRelations.Query().
		Where(jobrelations.YibfNo(input.YibfNo)).
		WithCompany().
		WithJob().
		WithOwner().
		WithContractor().
		WithAuthor().
		WithSupervisor().
		WithInspector().
		WithStatic().
		WithArchitect().
		WithMechanic().
		WithElectric().
		WithController().
		WithMechaniccontroller().
		WithElectriccontroller().
		First(txCtx)
	if err != nil && !ent.IsNotFound(err) {
		return nil, fmt.Errorf("kayıt aranırken hata oluştu: %w", err)
	}

	var (
		job        *ent.JobDetail
		owner      *ent.JobOwner
		contractor *ent.JobContractor
		author     *ent.JobAuthor
		supervisor *ent.JobSupervisor
		relations  *ent.JobRelations
	)

	if existingRelations != nil {
		fmt.Println("Mevcut kayıt bulundu...")
		relations = existingRelations

		// İş güncelleme/oluşturma
		if input.JobInput != nil {
			fmt.Println("İş işlemi başlıyor...")
			jobInput := *input.JobInput
			jobInput.YibfNo = &input.YibfNo
			if existingRelations.Edges.Job != nil {
				job, err = r.UpdateJob(txCtx, existingRelations.Edges.Job.YibfNo, jobInput)
				if err != nil {
					fmt.Printf("İş güncelleme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("iş güncellenirken hata: %w", err)
				}
				fmt.Printf("İş başarıyla güncellendi: %+v\n", job)
			} else {
				job, err = r.CreateJob(txCtx, jobInput)
				if err != nil {
					fmt.Printf("İş oluşturma hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("iş oluşturulurken hata: %w", err)
				}
				fmt.Printf("İş başarıyla oluşturuldu: %+v\n", job)
			}
		} else {
			job = existingRelations.Edges.Job
		}

		// Owner işlemi
		if input.OwnerInput != nil {
			fmt.Println("Owner işlemi başlıyor...")
			ownerInput := *input.OwnerInput
			ownerInput.YibfNo = &input.YibfNo

			if existingRelations.Edges.Owner != nil {
				// Mevcut owner'ı güncelle
				owner, err = r.UpdateOwner(txCtx, ownerInput)
				if err != nil {
					fmt.Printf("Owner güncelleme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("mal sahibi güncellenirken hata: %w", err)
				}
				fmt.Printf("Owner başarıyla güncellendi: %+v\n", owner)
			} else {
				// Yeni owner oluştur
				owner, err = r.CreateOwner(txCtx, ownerInput)
				if err != nil {
					fmt.Printf("Owner oluşturma hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("mal sahibi oluşturulurken hata: %w", err)
				}
				fmt.Printf("Owner başarıyla oluşturuldu: %+v\n", owner)

				// İlişkilendirmeyi güncelle
				update := tx.JobRelations.UpdateOne(relations)
				update.SetOwner(owner)
				if _, err = update.Save(txCtx); err != nil {
					fmt.Printf("Owner ilişkilendirme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("mal sahibi ilişkilendirilirken hata: %w", err)
				}
				fmt.Println("Owner ilişkilendirmesi başarıyla güncellendi")
			}
		} else {
			owner = existingRelations.Edges.Owner
		}

		// Contractor işlemi
		if input.ContractorInput != nil {
			fmt.Println("Contractor işlemi başlıyor...")
			contractorInput := *input.ContractorInput
			contractorInput.YibfNo = &input.YibfNo

			if existingRelations.Edges.Contractor != nil {
				// Mevcut contractor'ı güncelle
				contractor, err = r.UpdateContractor(txCtx, contractorInput)
				if err != nil {
					fmt.Printf("Contractor güncelleme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("yüklenici güncellenirken hata: %w", err)
				}
				fmt.Printf("Contractor başarıyla güncellendi: %+v\n", contractor)
			} else {
				// Yeni contractor oluştur
				contractor, err = r.CreateContractor(txCtx, contractorInput)
				if err != nil {
					fmt.Printf("Contractor oluşturma hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("yüklenici oluşturulurken hata: %w", err)
				}
				fmt.Printf("Contractor başarıyla oluşturuldu: %+v\n", contractor)

				// İlişkilendirmeyi güncelle
				update := tx.JobRelations.UpdateOne(relations)
				update.SetContractor(contractor)
				if _, err = update.Save(txCtx); err != nil {
					fmt.Printf("Contractor ilişkilendirme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("yüklenici ilişkilendirilirken hata: %w", err)
				}
				fmt.Println("Contractor ilişkilendirmesi başarıyla güncellendi")
			}
		} else {
			contractor = existingRelations.Edges.Contractor
		}

		// Author işlemi
		if input.AuthorInput != nil {
			fmt.Println("Author işlemi başlıyor...")
			authorInput := *input.AuthorInput
			authorInput.YibfNo = &input.YibfNo

			if existingRelations.Edges.Author != nil {
				// Mevcut author'ı güncelle
				author, err = r.UpdateAuthor(txCtx, input.YibfNo, authorInput)
				if err != nil {
					fmt.Printf("Author güncelleme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("proje müellifi güncellenirken hata: %w", err)
				}
				fmt.Printf("Author başarıyla güncellendi: %+v\n", author)
			} else {
				// Yeni author oluştur
				author, err = r.CreateAuthor(txCtx, authorInput)
				if err != nil {
					fmt.Printf("Author oluşturma hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("proje müellifi oluşturulurken hata: %w", err)
				}
				fmt.Printf("Author başarıyla oluşturuldu: %+v\n", author)

				// İlişkilendirmeyi güncelle
				update := tx.JobRelations.UpdateOne(relations)
				update.SetAuthor(author)
				if _, err = update.Save(txCtx); err != nil {
					fmt.Printf("Author ilişkilendirme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("proje müellifi ilişkilendirilirken hata: %w", err)
				}
				fmt.Println("Author ilişkilendirmesi başarıyla güncellendi")
			}
		} else {
			author = existingRelations.Edges.Author
		}

		// Supervisor işlemi
		if input.SupervisorInput != nil {
			fmt.Println("Supervisor işlemi başlıyor...")
			supervisorInput := *input.SupervisorInput
			supervisorInput.YibfNo = &input.YibfNo

			if existingRelations.Edges.Supervisor != nil {
				// Mevcut supervisor'ı güncelle
				supervisor, err = r.UpdateSupervisor(txCtx, supervisorInput)
				if err != nil {
					fmt.Printf("Supervisor güncelleme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("şantiye şefi güncellenirken hata: %w", err)
				}
				fmt.Printf("Supervisor başarıyla güncellendi: %+v\n", supervisor)
			} else {
				// Yeni supervisor oluştur
				supervisor, err = r.CreateSupervisor(txCtx, supervisorInput)
				if err != nil {
					fmt.Printf("Supervisor oluşturma hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("şantiye şefi oluşturulurken hata: %w", err)
				}
				fmt.Printf("Supervisor başarıyla oluşturuldu: %+v\n", supervisor)

				// İlişkilendirmeyi güncelle
				update := tx.JobRelations.UpdateOne(relations)
				update.SetSupervisor(supervisor)
				if _, err = update.Save(txCtx); err != nil {
					fmt.Printf("Supervisor ilişkilendirme hatası: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("şantiye şefi ilişkilendirilirken hata: %w", err)
				}
				fmt.Println("Supervisor ilişkilendirmesi başarıyla güncellendi")
			}
		} else {
			supervisor = existingRelations.Edges.Supervisor
		}

	} else {
		fmt.Println("Kayıt bulunamadı, yeni kayıt oluşturulacak...")

		// İş oluşturma - Bu işlem JobRelations'ı da oluşturacak
		fmt.Println("İş oluşturma başlıyor...")
		jobInput := *input.JobInput
		jobInput.YibfNo = &input.YibfNo
		job, err = r.CreateJob(txCtx, jobInput)
		if err != nil {
			fmt.Printf("İş oluşturma hatası: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("iş oluşturulurken hata: %w", err)
		}
		fmt.Printf("İş başarıyla oluşturuldu: %+v\n", job)

		// CompanyCode ile şirketi bul
		company, err := tx.CompanyDetail.Query().
			Where(companydetail.CompanyCodeEQ(*jobInput.CompanyCode)).
			Only(txCtx)
		if err != nil {
			fmt.Printf("Şirket bulma hatası: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("şirket bulunamadı (kod: %d): %w", *jobInput.CompanyCode, err)
		}

		// İlişkileri oluştur
		relations, err = tx.JobRelations.Create().
			SetYibfNo(input.YibfNo).
			SetJob(job).
			SetCompany(company).
			Save(txCtx)
		if err != nil {
			fmt.Printf("JobRelations oluşturma hatası: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("iş ilişkileri oluşturulurken hata: %w", err)
		}

		// Progress bilgilerini oluştur
		var one, two, three, four, five, six float64

		if jobInput.Level != nil {
			level := float64(*jobInput.Level)
			remaining := level

			// Sabit değerlere göre sıralı dağıtım:
			// one: 10, two: 10, three: 40, four: 20, five: 15, six: 5

			if remaining >= 10 {
				one = 10
				remaining -= 10
			} else {
				one = remaining
				remaining = 0
			}

			if remaining >= 10 {
				two = 10
				remaining -= 10
			} else {
				two = remaining
				remaining = 0
			}

			if remaining >= 40 {
				three = 40
				remaining -= 40
			} else {
				three = remaining
				remaining = 0
			}

			if remaining >= 20 {
				four = 20
				remaining -= 20
			} else {
				four = remaining
				remaining = 0
			}

			if remaining >= 15 {
				five = 15
				remaining -= 15
			} else {
				five = remaining
				remaining = 0
			}

			if remaining > 0 {
				if remaining <= 5 {
					six = remaining
				} else {
					six = 5
				}
			}
		}

		p, err := tx.JobProgress.Create().
			SetYibfNo(input.YibfNo).
			SetOne(int(one)).
			SetTwo(int(two)).
			SetThree(int(three)).
			SetFour(int(four)).
			SetFive(int(five)).
			SetSix(int(six)).
			Save(txCtx)

		if err != nil {
			fmt.Printf("Progress oluşturma hatası: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("progress oluşturulamadı: %w", err)
		}

		// Progress'i JobRelations ile ilişkilendir
		relations, err = relations.Update().SetProgress(p).Save(txCtx)
		if err != nil {
			fmt.Printf("Progress ilişkilendirme hatası: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("progress ilişkilendirilemedi: %w", err)
		}
		fmt.Println("Progress başarıyla ilişkilendirildi")

		// Owner oluşturma
		if input.OwnerInput != nil {
			fmt.Println("Owner oluşturma başlıyor...")
			ownerInput := *input.OwnerInput
			ownerInput.YibfNo = &input.YibfNo
			owner, err = r.CreateOwner(txCtx, ownerInput)
			if err != nil {
				fmt.Printf("Owner oluşturma hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("mal sahibi oluşturulurken hata: %w", err)
			}
			fmt.Printf("Owner başarıyla oluşturuldu: %+v\n", owner)

			// İlişkilendirmeyi güncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetOwner(owner)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Owner ilişkilendirme hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("mal sahibi ilişkilendirilirken hata: %w", err)
			}
			fmt.Println("Owner ilişkilendirmesi başarıyla güncellendi")
		}

		// Contractor oluşturma
		if input.ContractorInput != nil {
			fmt.Println("Contractor oluşturma başlıyor...")
			contractorInput := *input.ContractorInput
			contractorInput.YibfNo = &input.YibfNo
			contractor, err = r.CreateContractor(txCtx, contractorInput)
			if err != nil {
				fmt.Printf("Contractor oluşturma hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("yüklenici oluşturulurken hata: %w", err)
			}
			fmt.Printf("Contractor başarıyla oluşturuldu: %+v\n", contractor)

			// İlişkilendirmeyi güncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetContractor(contractor)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Contractor ilişkilendirme hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("yüklenici ilişkilendirilirken hata: %w", err)
			}
			fmt.Println("Contractor ilişkilendirmesi başarıyla güncellendi")
		}

		// Author oluşturma
		if input.AuthorInput != nil {
			fmt.Println("Author oluşturma başlıyor...")
			authorInput := *input.AuthorInput
			authorInput.YibfNo = &input.YibfNo
			author, err = r.CreateAuthor(txCtx, authorInput)
			if err != nil {
				fmt.Printf("Author oluşturma hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("proje müellifi oluşturulurken hata: %w", err)
			}
			fmt.Printf("Author başarıyla oluşturuldu: %+v\n", author)

			// İlişkilendirmeyi güncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetAuthor(author)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Author ilişkilendirme hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("proje müellifi ilişkilendirilirken hata: %w", err)
			}
			fmt.Println("Author ilişkilendirmesi başarıyla güncellendi")
		}

		// Supervisor oluşturma
		if input.SupervisorInput != nil {
			fmt.Println("Supervisor oluşturma başlıyor...")
			supervisorInput := *input.SupervisorInput
			supervisorInput.YibfNo = &input.YibfNo
			supervisor, err = r.CreateSupervisor(txCtx, supervisorInput)
			if err != nil {
				fmt.Printf("Supervisor oluşturma hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("şantiye şefi oluşturulurken hata: %w", err)
			}
			fmt.Printf("Supervisor başarıyla oluşturuldu: %+v\n", supervisor)

			// İlişkilendirmeyi güncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetSupervisor(supervisor)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Supervisor ilişkilendirme hatası: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("şantiye şefi ilişkilendirilirken hata: %w", err)
			}
			fmt.Println("Supervisor ilişkilendirmesi başarıyla güncellendi")
		}
	}

	// Mühendis ilişkilerini güncelle (opsiyonel)
	var jobEngineer *model.JobEngineer
	if input.EngineerInput != nil {
		fmt.Println("Mühendis ilişkileri güncelleme başlıyor...")
		engineerInput := *input.EngineerInput
		engineerInput.YibfNo = &input.YibfNo
		engineers, err := helpers.ValidateAndGetEngineers(txCtx, engineerInput)
		if err != nil {
			fmt.Printf("Mühendis doğrulama hatası: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("mühendisler doğrulanırken hata: %w", err)
		}
		fmt.Printf("Mühendisler başarıyla doğrulandı: %+v\n", engineers)

		update := tx.JobRelations.UpdateOne(relations)
		if inspector, ok := engineers["inspector"]; ok {
			update.SetInspector(inspector)
		}
		if static, ok := engineers["static"]; ok {
			update.SetStatic(static)
		}
		if architect, ok := engineers["architect"]; ok {
			update.SetArchitect(architect)
		}
		if mechanic, ok := engineers["mechanic"]; ok {
			update.SetMechanic(mechanic)
		}
		if electric, ok := engineers["electric"]; ok {
			update.SetElectric(electric)
		}
		if controller, ok := engineers["controller"]; ok {
			update.SetController(controller)
		}
		if mechanicController, ok := engineers["mechanicController"]; ok {
			update.SetMechaniccontroller(mechanicController)
		}
		if electricController, ok := engineers["electricController"]; ok {
			update.SetElectriccontroller(electricController)
		}

		if relations, err = update.Save(txCtx); err != nil {
			fmt.Printf("Mühendis ilişkileri güncelleme hatası: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("mühendis ilişkileri güncellenirken hata: %w", err)
		}
		fmt.Println("Mühendis ilişkileri başarıyla güncellendi")
	}

	// JobEngineer bilgilerini al
	jobEngineer = &model.JobEngineer{
		YibfNo:             &relations.YibfNo,
		Inspector:          relations.Edges.Inspector,
		Static:             relations.Edges.Static,
		Architect:          relations.Edges.Architect,
		Mechanic:           relations.Edges.Mechanic,
		Electric:           relations.Edges.Electric,
		Controller:         relations.Edges.Controller,
		MechanicController: relations.Edges.Mechaniccontroller,
		ElectricController: relations.Edges.Electriccontroller,
	}

	// Transaction'ı commit et
	fmt.Println("Transaction commit ediliyor...")
	if err := tx.Commit(); err != nil {
		fmt.Printf("Transaction commit hatası: %v\n", err)
		return nil, fmt.Errorf("değişiklikler kaydedilirken hata: %w", err)
	}
	fmt.Println("Transaction başarıyla commit edildi")

	return &model.JobBatchResult{
		Job:        job,
		Owner:      owner,
		Contractor: contractor,
		Author:     author,
		Supervisor: supervisor,
		Engineer:   jobEngineer,
	}, nil
}

// DeleteBatchMutation is the resolver for the deleteBatchMutation field.
func (r *mutationResolver) DeleteBatchMutation(ctx context.Context, yibfNo int) (*model.JobBatchResult, error) {
	client := middlewares.GetClientFromContext(ctx)
	if client == nil {
		return nil, fmt.Errorf("client nil")
	}

	// Transaction başlat
	tx, err := client.Tx(ctx)
	if err != nil {
		return nil, fmt.Errorf("transaction başlatılırken hata oluştu: %w", err)
	}

	defer func() {
		if v := recover(); v != nil {
			fmt.Printf("Panic oluştu: %v\n", v)
			_ = tx.Rollback()
			panic(v)
		}
	}()

	txCtx := ent.NewContext(ctx, tx.Client())

	// Silinecek kaydı bul
	relations, err := tx.JobRelations.Query().
		Where(jobrelations.YibfNo(yibfNo)).
		WithCompany().
		WithJob().
		WithOwner().
		WithContractor().
		WithAuthor().
		WithSupervisor().
		WithInspector().
		WithStatic().
		WithArchitect().
		WithMechanic().
		WithElectric().
		WithController().
		WithMechaniccontroller().
		WithElectriccontroller().
		WithProgress().
		First(txCtx)
	if err != nil {
		if ent.IsNotFound(err) {
			return nil, fmt.Errorf("%d Yibf No için kayıt bulunamadı", yibfNo)
		}
		return nil, fmt.Errorf("kayıt aranırken hata oluştu: %w", err)
	}

	// Silmeden önce sonuç için verileri saklayalım
	result := &model.JobBatchResult{
		Job:        relations.Edges.Job,
		Owner:      relations.Edges.Owner,
		Contractor: relations.Edges.Contractor,
		Author:     relations.Edges.Author,
		Supervisor: relations.Edges.Supervisor,
		Engineer: &model.JobEngineer{
			YibfNo:             &relations.YibfNo,
			Inspector:          relations.Edges.Inspector,
			Static:             relations.Edges.Static,
			Architect:          relations.Edges.Architect,
			Mechanic:           relations.Edges.Mechanic,
			Electric:           relations.Edges.Electric,
			Controller:         relations.Edges.Controller,
			MechanicController: relations.Edges.Mechaniccontroller,
			ElectricController: relations.Edges.Electriccontroller,
		},
		Progress: relations.Edges.Progress,
		Company:  relations.Edges.Company,
	}

	fmt.Printf("Silme işlemi başlıyor: YibfNo=%d\n", yibfNo)

	// İlişkili verileri sil
	// Progress kaydını sil
	if relations.Edges.Progress != nil {
		if err := tx.JobProgress.DeleteOne(relations.Edges.Progress).Exec(txCtx); err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("ilerleme kaydı silinirken hata: %w", err)
		}
		fmt.Println("İlerleme kaydı başarıyla silindi")
	}

	// JobDetail kaydını sil
	if relations.Edges.Job != nil {
		if err := tx.JobDetail.DeleteOne(relations.Edges.Job).Exec(txCtx); err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("iş detayı silinirken hata: %w", err)
		}
		fmt.Println("İş detayı başarıyla silindi")
	}

	// JobOwner kaydını sil - Başka işlerle ilişkisi yoksa
	if relations.Edges.Owner != nil {
		// Owner'ın başka işlerle ilişkisi var mı kontrol et
		count, err := tx.JobRelations.Query().
			Where(
				jobrelations.HasOwnerWith(
					jobowner.IDEQ(relations.Edges.Owner.ID),
				),
				jobrelations.YibfNoNEQ(yibfNo),
			).Count(txCtx)
		if err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("mal sahibi ilişkileri kontrol edilirken hata: %w", err)
		}

		fmt.Printf("Mal sahibi başka %d iş ile ilişkili\n", count)

		if count == 0 {
			// Başka ilişkisi yoksa sil
			if err := tx.JobOwner.DeleteOne(relations.Edges.Owner).Exec(txCtx); err != nil {
				_ = tx.Rollback()
				return nil, fmt.Errorf("mal sahibi kaydı silinirken hata: %w", err)
			}
			fmt.Println("Mal sahibi kaydı başarıyla silindi")
		} else {
			fmt.Printf("Mal sahibi başka %d iş ile ilişkili olduğu için silinmedi\n", count)
		}
	}

	// JobContractor kaydını sil - Başka işlerle ilişkisi yoksa
	if relations.Edges.Contractor != nil {
		// Contractor'ın başka işlerle ilişkisi var mı kontrol et
		count, err := tx.JobRelations.Query().
			Where(
				jobrelations.HasContractorWith(
					jobcontractor.IDEQ(relations.Edges.Contractor.ID),
				),
				jobrelations.YibfNoNEQ(yibfNo),
			).Count(txCtx)
		if err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("yüklenici ilişkileri kontrol edilirken hata: %w", err)
		}

		if count == 0 {
			// Başka ilişkisi yoksa sil
			if err := tx.JobContractor.DeleteOne(relations.Edges.Contractor).Exec(txCtx); err != nil {
				_ = tx.Rollback()
				return nil, fmt.Errorf("yüklenici kaydı silinirken hata: %w", err)
			}
			fmt.Println("Yüklenici kaydı başarıyla silindi")
		} else {
			fmt.Printf("Yüklenici başka %d iş ile ilişkili olduğu için silinmedi\n", count)
		}
	}

	// JobAuthor kaydını sil - İşe özel olduğundan doğrudan sil
	if relations.Edges.Author != nil {
		if err := tx.JobAuthor.DeleteOne(relations.Edges.Author).Exec(txCtx); err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("proje müellifi kaydı silinirken hata: %w", err)
		}
		fmt.Println("Proje müellifi kaydı başarıyla silindi")
	}

	// JobSupervisor kaydını sil - Başka işlerle ilişkisi yoksa
	if relations.Edges.Supervisor != nil {
		// Supervisor'ın başka işlerle ilişkisi var mı kontrol et
		count, err := tx.JobRelations.Query().
			Where(
				jobrelations.HasSupervisorWith(
					jobsupervisor.IDEQ(relations.Edges.Supervisor.ID),
				),
				jobrelations.YibfNoNEQ(yibfNo),
			).Count(txCtx)
		if err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("şantiye şefi ilişkileri kontrol edilirken hata: %w", err)
		}

		if count == 0 {
			// Başka ilişkisi yoksa sil
			if err := tx.JobSupervisor.DeleteOne(relations.Edges.Supervisor).Exec(txCtx); err != nil {
				_ = tx.Rollback()
				return nil, fmt.Errorf("şantiye şefi kaydı silinirken hata: %w", err)
			}
			fmt.Println("Şantiye şefi kaydı başarıyla silindi")
		} else {
			fmt.Printf("Şantiye şefi başka %d iş ile ilişkili olduğu için silinmedi\n", count)
		}
	}

	// JobRelations kaydını sil
	if err := tx.JobRelations.DeleteOne(relations).Exec(txCtx); err != nil {
		_ = tx.Rollback()
		return nil, fmt.Errorf("iş ilişkileri kaydı silinirken hata: %w", err)
	}
	fmt.Println("İş ilişkileri kaydı başarıyla silindi")

	// Transaction'ı commit et
	fmt.Println("Transaction commit ediliyor...")
	if err := tx.Commit(); err != nil {
		fmt.Printf("Transaction commit hatası: %v\n", err)
		return nil, fmt.Errorf("değişiklikler kaydedilirken hata: %w", err)
	}
	fmt.Println("Transaction başarıyla commit edildi")

	// Silme işleminden sonra, aynı YibfNo ile kayıt olup olmadığını kontrol edelim
	// Eğer hala varsa, bu bir tutarsızlık durumudur ve düzeltilmesi gerekir
	checkClient := middlewares.GetClientFromContext(ctx)
	if checkClient != nil {
		// JobDetail kontrolü
		exists, err := checkClient.JobDetail.Query().Where(jobdetail.YibfNo(yibfNo)).Exist(ctx)
		if err == nil && exists {
			fmt.Printf("UYARI: YibfNo=%d için JobDetail kaydı hala mevcut, zorla siliniyor...\n", yibfNo)
			// Zorla silme işlemi
			_, err = checkClient.JobDetail.Delete().Where(jobdetail.YibfNo(yibfNo)).Exec(ctx)
			if err != nil {
				fmt.Printf("JobDetail zorla silme hatası: %v\n", err)
			} else {
				fmt.Println("JobDetail kaydı zorla silindi")
			}
		}

		// JobRelations kontrolü
		exists, err = checkClient.JobRelations.Query().Where(jobrelations.YibfNo(yibfNo)).Exist(ctx)
		if err == nil && exists {
			fmt.Printf("UYARI: YibfNo=%d için JobRelations kaydı hala mevcut, zorla siliniyor...\n", yibfNo)
			// Zorla silme işlemi
			_, err = checkClient.JobRelations.Delete().Where(jobrelations.YibfNo(yibfNo)).Exec(ctx)
			if err != nil {
				fmt.Printf("JobRelations zorla silme hatası: %v\n", err)
			} else {
				fmt.Println("JobRelations kaydı zorla silindi")
			}
		}
	}

	return result, nil
}

// JobBatchQuery is the resolver for the jobBatchQuery field.
func (r *queryResolver) JobBatchQuery(ctx context.Context, yibfNo *int, state *string) ([]*model.JobBatchResult, error) {
	client := middlewares.GetClientFromContext(ctx)
	if client == nil {
		return nil, fmt.Errorf("client nil")
	}

	// Query builder'ı başlat
	query := client.JobRelations.Query()

	// State kontrolü - state değeri "all" değilse bitmişleri gösterme
	if state == nil || *state != "all" {
		query = query.Where(jobrelations.HasJobWith(jobdetail.StateNEQ("Bitmiş")))
	}

	// Eğer yibfNo belirtilmişse filtreleme yap
	if yibfNo != nil {
		query = query.Where(jobrelations.YibfNo(*yibfNo))
	}

	// Sadece gerekli ilişkileri yükle
	query = query.WithCompany().
		WithJob().
		WithOwner().
		WithContractor().
		WithAuthor().
		WithSupervisor().
		WithProgress().
		WithInspector().
		WithStatic().
		WithArchitect().
		WithMechanic().
		WithElectric().
		WithController().
		WithMechaniccontroller().
		WithElectriccontroller()

	// Tüm kayıtları getir
	relations, err := query.All(ctx)
	if err != nil {
		return nil, fmt.Errorf("kayıtlar aranırken hata oluştu: %w", err)
	}

	// Sonuçları dönüştür
	var results []*model.JobBatchResult
	for _, relation := range relations {

		results = append(results, &model.JobBatchResult{
			Job:        relation.Edges.Job,
			Owner:      relation.Edges.Owner,
			Contractor: relation.Edges.Contractor,
			Author:     relation.Edges.Author,
			Supervisor: relation.Edges.Supervisor,
			Engineer: &model.JobEngineer{
				YibfNo:             &relation.YibfNo,
				Inspector:          relation.Edges.Inspector,
				Static:             relation.Edges.Static,
				Architect:          relation.Edges.Architect,
				Mechanic:           relation.Edges.Mechanic,
				Electric:           relation.Edges.Electric,
				Controller:         relation.Edges.Controller,
				MechanicController: relation.Edges.Mechaniccontroller,
				ElectricController: relation.Edges.Electriccontroller,
			},
			Progress: relation.Edges.Progress,
			Company:  relation.Edges.Company,
		})
	}

	if len(results) == 0 {
		if yibfNo != nil {
			return nil, fmt.Errorf("%d Yibf No için kayıt bulunamadı", *yibfNo)
		}
		return []*model.JobBatchResult{}, nil
	}

	return results, nil
}
