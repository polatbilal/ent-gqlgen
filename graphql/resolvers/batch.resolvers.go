package resolvers

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.85

import (
	"context"
	"fmt"
	"strings"

	"github.com/polatbilal/ent-gqlgen/ent"
	"github.com/polatbilal/ent-gqlgen/ent/companydetail"
	"github.com/polatbilal/ent-gqlgen/ent/companyuser"
	"github.com/polatbilal/ent-gqlgen/ent/jobcontractor"
	"github.com/polatbilal/ent-gqlgen/ent/jobdetail"
	"github.com/polatbilal/ent-gqlgen/ent/jobowner"
	"github.com/polatbilal/ent-gqlgen/ent/jobrelations"
	"github.com/polatbilal/ent-gqlgen/ent/jobsupervisor"
	"github.com/polatbilal/ent-gqlgen/ent/user"
	"github.com/polatbilal/ent-gqlgen/graphql/helpers"
	"github.com/polatbilal/ent-gqlgen/graphql/model"
	"github.com/polatbilal/ent-gqlgen/middlewares"
	"github.com/polatbilal/ent-gqlgen/tools"
)

// JobBatchMutation is the resolver for the jobBatchMutation field.
func (r *mutationResolver) JobBatchMutation(ctx context.Context, input model.JobBatchInput) (*model.JobBatchResult, error) {
	maxRetries := 3
	var lastErr error

	for attempt := 0; attempt < maxRetries; attempt++ {
		if attempt > 0 {
			fmt.Printf("Yeniden deneme %d/%d\n", attempt+1, maxRetries)
		}

		result, err := r.ExecuteBatchMutation(ctx, input)
		if err != nil {
			lastErr = err

			// EÄŸer kayÄ±t skip edildiyse (kritik alan eksik), baÅŸarÄ±lÄ± say
			if strings.HasPrefix(err.Error(), "skipped:") {
				fmt.Printf("ðŸ“‹ KayÄ±t atlandÄ± (YibfNo: %d): %s\n", input.YibfNo, err.Error())
				tools.LogBatchError(input.YibfNo, "SKIPPED", err.Error())
				return &model.JobBatchResult{}, nil // BoÅŸ result dÃ¶ndÃ¼r, hata yok
			}

			if strings.Contains(err.Error(), "duplicate key value violates unique constraint") {
				tools.LogBatchError(input.YibfNo, "DUPLICATE_KEY", err.Error())
				continue
			}
			tools.LogBatchError(input.YibfNo, "ERROR", err.Error())
			return nil, err
		}
		return result, nil
	}

	return nil, fmt.Errorf("maksimum deneme sayÄ±sÄ±na ulaÅŸÄ±ldÄ±, son hata: %w", lastErr)
}

// ExecuteBatchMutation is the resolver for the executeBatchMutation field.
func (r *mutationResolver) ExecuteBatchMutation(ctx context.Context, input model.JobBatchInput) (*model.JobBatchResult, error) {
	client := middlewares.GetClientFromContext(ctx)
	if client == nil {
		return nil, fmt.Errorf("client nil")
	}

	customClaim := middlewares.CtxValue(ctx)

	// KullanÄ±cÄ±nÄ±n ÅŸirketlerini al
	userCompanies, err := client.CompanyUser.Query().
		Where(companyuser.HasUserWith(user.IDEQ(customClaim.ID))).
		QueryCompany().
		All(ctx)
	if err != nil {
		return nil, fmt.Errorf("kullanÄ±cÄ± ÅŸirketleri alÄ±namadÄ±: %w", err)
	}

	// KullanÄ±cÄ±nÄ±n yetkili olduÄŸu ÅŸirket kodlarÄ±nÄ± topla
	var companyCodes []int
	for _, company := range userCompanies {
		companyCodes = append(companyCodes, company.CompanyCode)
	}

	tx, err := client.Tx(ctx)
	if err != nil {
		return nil, fmt.Errorf("transaction baÅŸlatÄ±lÄ±rken hata oluÅŸtu: %w", err)
	}

	defer func() {
		if v := recover(); v != nil {
			fmt.Printf("Panic oluÅŸtu: %v\n", v)
			_ = tx.Rollback()
			panic(v)
		}
	}()

	txCtx := ent.NewContext(ctx, tx.Client())

	// Mevcut JobRelations kaydÄ±nÄ± bul
	existingRelations, err := tx.JobRelations.Query().
		Where(jobrelations.YibfNo(input.YibfNo)).
		WithCompany().
		WithJob().
		WithOwner().
		WithContractor().
		WithAuthor().
		WithSupervisor().
		WithInspector().
		WithStatic().
		WithArchitect().
		WithMechanic().
		WithElectric().
		WithController().
		WithMechaniccontroller().
		WithElectriccontroller().
		First(txCtx)
	if err != nil && !ent.IsNotFound(err) {
		return nil, fmt.Errorf("kayÄ±t aranÄ±rken hata oluÅŸtu: %w", err)
	}

	var (
		job        *ent.JobDetail
		owner      *ent.JobOwner
		contractor *ent.JobContractor
		author     *ent.JobAuthor
		supervisor *ent.JobSupervisor
		relations  *ent.JobRelations
	)

	if existingRelations != nil {
		fmt.Println("Mevcut kayÄ±t bulundu...")

		// KullanÄ±cÄ±nÄ±n bu ÅŸirkete eriÅŸim yetkisi var mÄ± kontrol et
		if existingRelations.Edges.Company != nil {
			hasAccess := false
			for _, code := range companyCodes {
				if existingRelations.Edges.Company.CompanyCode == code {
					hasAccess = true
					break
				}
			}

			if !hasAccess {
				_ = tx.Rollback()
				return nil, fmt.Errorf("bu iÅŸi gÃ¼ncelleme yetkiniz yok")
			}
		}

		relations = existingRelations

		// Ä°ÅŸ gÃ¼ncelleme/oluÅŸturma
		if input.JobInput != nil {
			fmt.Println("Ä°ÅŸ iÅŸlemi baÅŸlÄ±yor...")
			jobInput := *input.JobInput
			jobInput.YibfNo = &input.YibfNo
			if existingRelations.Edges.Job != nil {
				job, err = r.UpdateJob(txCtx, existingRelations.Edges.Job.YibfNo, jobInput)
				if err != nil {
					fmt.Printf("Ä°ÅŸ gÃ¼ncelleme hatasÄ±: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("iÅŸ gÃ¼ncellenirken hata: %w", err)
				}
				fmt.Printf("Ä°ÅŸ baÅŸarÄ±yla gÃ¼ncellendi: %+v\n", job)
			} else {
				job, err = r.CreateJob(txCtx, jobInput)
				if err != nil {
					fmt.Printf("Ä°ÅŸ oluÅŸturma hatasÄ±: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("iÅŸ oluÅŸturulurken hata: %w", err)
				}
				fmt.Printf("Ä°ÅŸ baÅŸarÄ±yla oluÅŸturuldu: %+v\n", job)
			}
		} else {
			job = existingRelations.Edges.Job
		}

		// Owner iÅŸlemi
		if input.OwnerInput != nil {
			fmt.Println("Owner iÅŸlemi baÅŸlÄ±yor...")
			ownerInput := *input.OwnerInput
			ownerInput.YibfNo = &input.YibfNo

			// CreateOwner zaten varsa gÃ¼nceller, yoksa oluÅŸturur
			owner, err = r.CreateOwner(txCtx, ownerInput)
			if err != nil {
				// Owner kritik bir alan, eksikse bu YibfNo'yu skip et
				fmt.Printf("âŒ Owner eksik, YibfNo atlanÄ±yor: %d\n", input.YibfNo)
				tools.LogBatchError(input.YibfNo, "OWNER_MISSING", fmt.Sprintf("Mal sahibi bilgisi eksik: %v", err))
				_ = tx.Rollback()
				return nil, fmt.Errorf("skipped: mal sahibi bilgisi eksik - %w", err)
			}
			fmt.Printf("Owner baÅŸarÄ±yla iÅŸlendi: %+v\n", owner)

			// EÄŸer iliÅŸkilendirme yoksa ekle
			if existingRelations.Edges.Owner == nil {
				update := tx.JobRelations.UpdateOne(relations)
				update.SetOwner(owner)
				if _, err = update.Save(txCtx); err != nil {
					fmt.Printf("Owner iliÅŸkilendirme hatasÄ±: %v\n", err)
					_ = tx.Rollback()
					return nil, fmt.Errorf("mal sahibi iliÅŸkilendirilirken hata: %w", err)
				}
				fmt.Println("Owner iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
			}
		} else {
			owner = existingRelations.Edges.Owner
		}

		// Contractor iÅŸlemi (opsiyonel, eksik olabilir)
		if input.ContractorInput != nil {
			fmt.Println("Contractor iÅŸlemi baÅŸlÄ±yor...")
			contractorInput := *input.ContractorInput
			contractorInput.YibfNo = &input.YibfNo

			// CreateContractor zaten varsa gÃ¼nceller, yoksa oluÅŸturur
			contractor, err = r.CreateContractor(txCtx, contractorInput)
			if err != nil {
				// Contractor opsiyonel, eksikse atla ama devam et
				fmt.Printf("âš ï¸  Contractor iÅŸlemi atlandÄ± (YibfNo: %d): %v\n", input.YibfNo, err)
				tools.LogBatchError(input.YibfNo, "CONTRACTOR_WARNING", fmt.Sprintf("YÃ¼klenici bilgisi eksik: %v", err))
				contractor = existingRelations.Edges.Contractor // Mevcut deÄŸeri koru
			} else {
				fmt.Printf("Contractor baÅŸarÄ±yla iÅŸlendi: %+v\n", contractor)

				// EÄŸer iliÅŸkilendirme yoksa ekle
				if existingRelations.Edges.Contractor == nil {
					update := tx.JobRelations.UpdateOne(relations)
					update.SetContractor(contractor)
					if _, err = update.Save(txCtx); err != nil {
						fmt.Printf("Contractor iliÅŸkilendirme hatasÄ±: %v\n", err)
						_ = tx.Rollback()
						return nil, fmt.Errorf("yÃ¼klenici iliÅŸkilendirilirken hata: %w", err)
					}
					fmt.Println("Contractor iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
				}
			}
		} else {
			contractor = existingRelations.Edges.Contractor
		}

		// Author iÅŸlemi
		if input.AuthorInput != nil {
			fmt.Println("Author iÅŸlemi baÅŸlÄ±yor...")
			authorInput := *input.AuthorInput
			authorInput.YibfNo = &input.YibfNo

			// CreateAuthor zaten varsa gÃ¼nceller, yoksa oluÅŸturur
			author, err = r.CreateAuthor(txCtx, authorInput)
			if err != nil {
				// Eksik bilgi varsa hata verme, sadece uyar ve devam et
				fmt.Printf("âš ï¸  Author iÅŸlemi atlandÄ± (YibfNo: %d): %v\n", input.YibfNo, err)
				tools.LogBatchError(input.YibfNo, "AUTHOR_WARNING", fmt.Sprintf("Proje mÃ¼ellifi bilgisi eksik: %v", err))
				author = existingRelations.Edges.Author // Mevcut deÄŸeri koru
			} else {
				fmt.Printf("Author baÅŸarÄ±yla iÅŸlendi: %+v\n", author)

				// EÄŸer iliÅŸkilendirme yoksa ekle
				if existingRelations.Edges.Author == nil {
					update := tx.JobRelations.UpdateOne(relations)
					update.SetAuthor(author)
					if _, err = update.Save(txCtx); err != nil {
						fmt.Printf("Author iliÅŸkilendirme hatasÄ±: %v\n", err)
						_ = tx.Rollback()
						return nil, fmt.Errorf("proje mÃ¼ellifi iliÅŸkilendirilirken hata: %w", err)
					}
					fmt.Println("Author iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
				}
			}
		} else {
			author = existingRelations.Edges.Author
		}

		// Supervisor iÅŸlemi
		if input.SupervisorInput != nil {
			fmt.Println("Supervisor iÅŸlemi baÅŸlÄ±yor...")
			supervisorInput := *input.SupervisorInput
			supervisorInput.YibfNo = &input.YibfNo

			// CreateSupervisor zaten varsa gÃ¼nceller, yoksa oluÅŸturur
			supervisor, err = r.CreateSupervisor(txCtx, supervisorInput)
			if err != nil {
				// Eksik bilgi varsa hata verme, sadece uyar ve devam et
				fmt.Printf("âš ï¸  Supervisor iÅŸlemi atlandÄ± (YibfNo: %d): %v\n", input.YibfNo, err)
				tools.LogBatchError(input.YibfNo, "SUPERVISOR_WARNING", fmt.Sprintf("Åžantiye ÅŸefi bilgisi eksik: %v", err))
				supervisor = existingRelations.Edges.Supervisor // Mevcut deÄŸeri koru
			} else {
				fmt.Printf("Supervisor baÅŸarÄ±yla iÅŸlendi: %+v\n", supervisor)

				// EÄŸer iliÅŸkilendirme yoksa ekle
				if existingRelations.Edges.Supervisor == nil {
					update := tx.JobRelations.UpdateOne(relations)
					update.SetSupervisor(supervisor)
					if _, err = update.Save(txCtx); err != nil {
						fmt.Printf("Supervisor iliÅŸkilendirme hatasÄ±: %v\n", err)
						_ = tx.Rollback()
						return nil, fmt.Errorf("ÅŸantiye ÅŸefi iliÅŸkilendirilirken hata: %w", err)
					}
					fmt.Println("Supervisor iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
				}
			}
		} else {
			supervisor = existingRelations.Edges.Supervisor
		}

	} else {
		fmt.Println("KayÄ±t bulunamadÄ±, yeni kayÄ±t oluÅŸturulacak...")

		// Ä°ÅŸ oluÅŸturma - Bu iÅŸlem JobRelations'Ä± da oluÅŸturacak
		fmt.Println("Ä°ÅŸ oluÅŸturma baÅŸlÄ±yor...")
		jobInput := *input.JobInput
		jobInput.YibfNo = &input.YibfNo
		job, err = r.CreateJob(txCtx, jobInput)
		if err != nil {
			fmt.Printf("Ä°ÅŸ oluÅŸturma hatasÄ±: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("iÅŸ oluÅŸturulurken hata: %w", err)
		}
		fmt.Printf("Ä°ÅŸ baÅŸarÄ±yla oluÅŸturuldu: %+v\n", job)

		// CompanyCode ile ÅŸirketi bul
		company, err := tx.CompanyDetail.Query().
			Where(companydetail.CompanyCodeEQ(*jobInput.CompanyCode)).
			Only(txCtx)
		if err != nil {
			fmt.Printf("Åžirket bulma hatasÄ±: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("ÅŸirket bulunamadÄ± (kod: %d): %w", *jobInput.CompanyCode, err)
		}

		// KullanÄ±cÄ±nÄ±n bu ÅŸirkete eriÅŸim yetkisi var mÄ± kontrol et
		hasAccess := false
		for _, code := range companyCodes {
			if company.CompanyCode == code {
				hasAccess = true
				break
			}
		}

		if !hasAccess {
			_ = tx.Rollback()
			return nil, fmt.Errorf("bu ÅŸirket iÃ§in iÅŸ oluÅŸturma yetkiniz yok")
		}

		// Ä°liÅŸkileri oluÅŸtur
		relations, err = tx.JobRelations.Create().
			SetYibfNo(input.YibfNo).
			SetJob(job).
			SetCompany(company).
			Save(txCtx)
		if err != nil {
			fmt.Printf("JobRelations oluÅŸturma hatasÄ±: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("iÅŸ iliÅŸkileri oluÅŸturulurken hata: %w", err)
		}

		// Progress bilgilerini oluÅŸtur
		var one, two, three, four, five, six float64

		if jobInput.Level != nil {
			level := float64(*jobInput.Level)
			remaining := level

			// Sabit deÄŸerlere gÃ¶re sÄ±ralÄ± daÄŸÄ±tÄ±m:
			// one: 10, two: 10, three: 40, four: 20, five: 15, six: 5

			if remaining >= 10 {
				one = 10
				remaining -= 10
			} else {
				one = remaining
				remaining = 0
			}

			if remaining >= 10 {
				two = 10
				remaining -= 10
			} else {
				two = remaining
				remaining = 0
			}

			if remaining >= 40 {
				three = 40
				remaining -= 40
			} else {
				three = remaining
				remaining = 0
			}

			if remaining >= 20 {
				four = 20
				remaining -= 20
			} else {
				four = remaining
				remaining = 0
			}

			if remaining >= 15 {
				five = 15
				remaining -= 15
			} else {
				five = remaining
				remaining = 0
			}

			if remaining > 0 {
				if remaining <= 5 {
					six = remaining
				} else {
					six = 5
				}
			}
		}

		p, err := tx.JobProgress.Create().
			SetYibfNo(input.YibfNo).
			SetOne(int(one)).
			SetTwo(int(two)).
			SetThree(int(three)).
			SetFour(int(four)).
			SetFive(int(five)).
			SetSix(int(six)).
			Save(txCtx)

		if err != nil {
			fmt.Printf("Progress oluÅŸturma hatasÄ±: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("progress oluÅŸturulamadÄ±: %w", err)
		}

		// Progress'i JobRelations ile iliÅŸkilendir
		relations, err = relations.Update().SetProgress(p).Save(txCtx)
		if err != nil {
			fmt.Printf("Progress iliÅŸkilendirme hatasÄ±: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("progress iliÅŸkilendirilemedi: %w", err)
		}
		fmt.Println("Progress baÅŸarÄ±yla iliÅŸkilendirildi")

		// Owner oluÅŸturma
		if input.OwnerInput != nil {
			fmt.Println("Owner oluÅŸturma baÅŸlÄ±yor...")
			ownerInput := *input.OwnerInput
			ownerInput.YibfNo = &input.YibfNo
			owner, err = r.CreateOwner(txCtx, ownerInput)
			if err != nil {
				fmt.Printf("Owner oluÅŸturma hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("mal sahibi oluÅŸturulurken hata: %w", err)
			}
			fmt.Printf("Owner baÅŸarÄ±yla oluÅŸturuldu: %+v\n", owner)

			// Ä°liÅŸkilendirmeyi gÃ¼ncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetOwner(owner)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Owner iliÅŸkilendirme hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("mal sahibi iliÅŸkilendirilirken hata: %w", err)
			}
			fmt.Println("Owner iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
		}

		// Contractor oluÅŸturma
		if input.ContractorInput != nil {
			fmt.Println("Contractor oluÅŸturma baÅŸlÄ±yor...")
			contractorInput := *input.ContractorInput
			contractorInput.YibfNo = &input.YibfNo
			contractor, err = r.CreateContractor(txCtx, contractorInput)
			if err != nil {
				fmt.Printf("Contractor oluÅŸturma hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("yÃ¼klenici oluÅŸturulurken hata: %w", err)
			}
			fmt.Printf("Contractor baÅŸarÄ±yla oluÅŸturuldu: %+v\n", contractor)

			// Ä°liÅŸkilendirmeyi gÃ¼ncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetContractor(contractor)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Contractor iliÅŸkilendirme hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("yÃ¼klenici iliÅŸkilendirilirken hata: %w", err)
			}
			fmt.Println("Contractor iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
		}

		// Author oluÅŸturma
		if input.AuthorInput != nil {
			fmt.Println("Author oluÅŸturma baÅŸlÄ±yor...")
			authorInput := *input.AuthorInput
			authorInput.YibfNo = &input.YibfNo
			author, err = r.CreateAuthor(txCtx, authorInput)
			if err != nil {
				fmt.Printf("Author oluÅŸturma hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("proje mÃ¼ellifi oluÅŸturulurken hata: %w", err)
			}
			fmt.Printf("Author baÅŸarÄ±yla oluÅŸturuldu: %+v\n", author)

			// Ä°liÅŸkilendirmeyi gÃ¼ncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetAuthor(author)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Author iliÅŸkilendirme hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("proje mÃ¼ellifi iliÅŸkilendirilirken hata: %w", err)
			}
			fmt.Println("Author iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
		}

		// Supervisor oluÅŸturma
		if input.SupervisorInput != nil {
			fmt.Println("Supervisor oluÅŸturma baÅŸlÄ±yor...")
			supervisorInput := *input.SupervisorInput
			supervisorInput.YibfNo = &input.YibfNo
			supervisor, err = r.CreateSupervisor(txCtx, supervisorInput)
			if err != nil {
				fmt.Printf("Supervisor oluÅŸturma hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("ÅŸantiye ÅŸefi oluÅŸturulurken hata: %w", err)
			}
			fmt.Printf("Supervisor baÅŸarÄ±yla oluÅŸturuldu: %+v\n", supervisor)

			// Ä°liÅŸkilendirmeyi gÃ¼ncelle
			update := tx.JobRelations.UpdateOne(relations)
			update.SetSupervisor(supervisor)
			if _, err = update.Save(txCtx); err != nil {
				fmt.Printf("Supervisor iliÅŸkilendirme hatasÄ±: %v\n", err)
				_ = tx.Rollback()
				return nil, fmt.Errorf("ÅŸantiye ÅŸefi iliÅŸkilendirilirken hata: %w", err)
			}
			fmt.Println("Supervisor iliÅŸkilendirmesi baÅŸarÄ±yla gÃ¼ncellendi")
		}
	}

	// MÃ¼hendis iliÅŸkilerini gÃ¼ncelle (opsiyonel)
	var jobEngineer *model.JobEngineer
	if input.EngineerInput != nil {
		fmt.Println("MÃ¼hendis iliÅŸkileri gÃ¼ncelleme baÅŸlÄ±yor...")
		engineerInput := *input.EngineerInput
		engineerInput.YibfNo = &input.YibfNo
		engineers, err := helpers.ValidateAndGetEngineers(txCtx, engineerInput)
		if err != nil {
			fmt.Printf("MÃ¼hendis doÄŸrulama hatasÄ±: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("mÃ¼hendisler doÄŸrulanÄ±rken hata: %w", err)
		}
		fmt.Printf("MÃ¼hendisler baÅŸarÄ±yla doÄŸrulandÄ±: %+v\n", engineers)

		update := tx.JobRelations.UpdateOne(relations)
		if inspector, ok := engineers["inspector"]; ok {
			update.SetInspector(inspector)
		}
		if static, ok := engineers["static"]; ok {
			update.SetStatic(static)
		}
		if architect, ok := engineers["architect"]; ok {
			update.SetArchitect(architect)
		}
		if mechanic, ok := engineers["mechanic"]; ok {
			update.SetMechanic(mechanic)
		}
		if electric, ok := engineers["electric"]; ok {
			update.SetElectric(electric)
		}
		if controller, ok := engineers["controller"]; ok {
			update.SetController(controller)
		}
		if mechanicController, ok := engineers["mechanicController"]; ok {
			update.SetMechaniccontroller(mechanicController)
		}
		if electricController, ok := engineers["electricController"]; ok {
			update.SetElectriccontroller(electricController)
		}

		if relations, err = update.Save(txCtx); err != nil {
			fmt.Printf("MÃ¼hendis iliÅŸkileri gÃ¼ncelleme hatasÄ±: %v\n", err)
			_ = tx.Rollback()
			return nil, fmt.Errorf("mÃ¼hendis iliÅŸkileri gÃ¼ncellenirken hata: %w", err)
		}
		fmt.Println("MÃ¼hendis iliÅŸkileri baÅŸarÄ±yla gÃ¼ncellendi")
	}

	// JobEngineer bilgilerini al
	jobEngineer = &model.JobEngineer{
		YibfNo:             &relations.YibfNo,
		Inspector:          relations.Edges.Inspector,
		Static:             relations.Edges.Static,
		Architect:          relations.Edges.Architect,
		Mechanic:           relations.Edges.Mechanic,
		Electric:           relations.Edges.Electric,
		Controller:         relations.Edges.Controller,
		MechanicController: relations.Edges.Mechaniccontroller,
		ElectricController: relations.Edges.Electriccontroller,
	}

	// Transaction'Ä± commit et
	fmt.Println("Transaction commit ediliyor...")
	if err := tx.Commit(); err != nil {
		fmt.Printf("Transaction commit hatasÄ±: %v\n", err)
		return nil, fmt.Errorf("deÄŸiÅŸiklikler kaydedilirken hata: %w", err)
	}
	fmt.Println("Transaction baÅŸarÄ±yla commit edildi")

	return &model.JobBatchResult{
		Job:        job,
		Owner:      owner,
		Contractor: contractor,
		Author:     author,
		Supervisor: supervisor,
		Engineer:   jobEngineer,
	}, nil
}

// DeleteBatchMutation is the resolver for the deleteBatchMutation field.
func (r *mutationResolver) DeleteBatchMutation(ctx context.Context, yibfNo int) (*model.JobBatchResult, error) {
	client := middlewares.GetClientFromContext(ctx)
	if client == nil {
		return nil, fmt.Errorf("client nil")
	}

	customClaim := middlewares.CtxValue(ctx)

	// KullanÄ±cÄ±nÄ±n ÅŸirketlerini al
	userCompanies, err := client.CompanyUser.Query().
		Where(companyuser.HasUserWith(user.IDEQ(customClaim.ID))).
		QueryCompany().
		All(ctx)
	if err != nil {
		return nil, fmt.Errorf("kullanÄ±cÄ± ÅŸirketleri alÄ±namadÄ±: %w", err)
	}

	// KullanÄ±cÄ±nÄ±n yetkili olduÄŸu ÅŸirket kodlarÄ±nÄ± topla
	var companyCodes []int
	for _, company := range userCompanies {
		companyCodes = append(companyCodes, company.CompanyCode)
	}

	// Transaction baÅŸlat
	tx, err := client.Tx(ctx)
	if err != nil {
		return nil, fmt.Errorf("transaction baÅŸlatÄ±lÄ±rken hata oluÅŸtu: %w", err)
	}

	defer func() {
		if v := recover(); v != nil {
			fmt.Printf("Panic oluÅŸtu: %v\n", v)
			_ = tx.Rollback()
			panic(v)
		}
	}()

	txCtx := ent.NewContext(ctx, tx.Client())

	// Silinecek kaydÄ± bul
	relations, err := tx.JobRelations.Query().
		Where(jobrelations.YibfNo(yibfNo)).
		WithCompany().
		WithJob().
		WithOwner().
		WithContractor().
		WithAuthor().
		WithSupervisor().
		WithInspector().
		WithStatic().
		WithArchitect().
		WithMechanic().
		WithElectric().
		WithController().
		WithMechaniccontroller().
		WithElectriccontroller().
		WithProgress().
		First(txCtx)
	if err != nil {
		if ent.IsNotFound(err) {
			return nil, fmt.Errorf("%d Yibf No iÃ§in kayÄ±t bulunamadÄ±", yibfNo)
		}
		return nil, fmt.Errorf("kayÄ±t aranÄ±rken hata oluÅŸtu: %w", err)
	}

	// KullanÄ±cÄ±nÄ±n bu ÅŸirkete eriÅŸim yetkisi var mÄ± kontrol et
	if relations.Edges.Company == nil {
		_ = tx.Rollback()
		return nil, fmt.Errorf("kayÄ±t ÅŸirket bilgisi iÃ§ermiyor")
	}

	hasAccess := false
	for _, code := range companyCodes {
		if relations.Edges.Company.CompanyCode == code {
			hasAccess = true
			break
		}
	}

	if !hasAccess {
		_ = tx.Rollback()
		return nil, fmt.Errorf("bu iÅŸi silme yetkiniz yok")
	}

	// Silmeden Ã¶nce sonuÃ§ iÃ§in verileri saklayalÄ±m
	result := &model.JobBatchResult{
		Job:        relations.Edges.Job,
		Owner:      relations.Edges.Owner,
		Contractor: relations.Edges.Contractor,
		Author:     relations.Edges.Author,
		Supervisor: relations.Edges.Supervisor,
		Engineer: &model.JobEngineer{
			YibfNo:             &relations.YibfNo,
			Inspector:          relations.Edges.Inspector,
			Static:             relations.Edges.Static,
			Architect:          relations.Edges.Architect,
			Mechanic:           relations.Edges.Mechanic,
			Electric:           relations.Edges.Electric,
			Controller:         relations.Edges.Controller,
			MechanicController: relations.Edges.Mechaniccontroller,
			ElectricController: relations.Edges.Electriccontroller,
		},
		Progress: relations.Edges.Progress,
		Company:  relations.Edges.Company,
	}

	fmt.Printf("Silme iÅŸlemi baÅŸlÄ±yor: YibfNo=%d\n", yibfNo)

	// Ä°liÅŸkili verileri sil
	// Progress kaydÄ±nÄ± sil
	if relations.Edges.Progress != nil {
		if err := tx.JobProgress.DeleteOne(relations.Edges.Progress).Exec(txCtx); err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("ilerleme kaydÄ± silinirken hata: %w", err)
		}
		fmt.Println("Ä°lerleme kaydÄ± baÅŸarÄ±yla silindi")
	}

	// JobDetail kaydÄ±nÄ± sil
	if relations.Edges.Job != nil {
		if err := tx.JobDetail.DeleteOne(relations.Edges.Job).Exec(txCtx); err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("iÅŸ detayÄ± silinirken hata: %w", err)
		}
		fmt.Println("Ä°ÅŸ detayÄ± baÅŸarÄ±yla silindi")
	}

	// JobOwner kaydÄ±nÄ± sil - BaÅŸka iÅŸlerle iliÅŸkisi yoksa
	if relations.Edges.Owner != nil {
		// Owner'Ä±n baÅŸka iÅŸlerle iliÅŸkisi var mÄ± kontrol et
		count, err := tx.JobRelations.Query().
			Where(
				jobrelations.HasOwnerWith(
					jobowner.IDEQ(relations.Edges.Owner.ID),
				),
				jobrelations.YibfNoNEQ(yibfNo),
			).Count(txCtx)
		if err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("mal sahibi iliÅŸkileri kontrol edilirken hata: %w", err)
		}

		fmt.Printf("Mal sahibi baÅŸka %d iÅŸ ile iliÅŸkili\n", count)

		if count == 0 {
			// BaÅŸka iliÅŸkisi yoksa sil
			if err := tx.JobOwner.DeleteOne(relations.Edges.Owner).Exec(txCtx); err != nil {
				_ = tx.Rollback()
				return nil, fmt.Errorf("mal sahibi kaydÄ± silinirken hata: %w", err)
			}
			fmt.Println("Mal sahibi kaydÄ± baÅŸarÄ±yla silindi")
		} else {
			fmt.Printf("Mal sahibi baÅŸka %d iÅŸ ile iliÅŸkili olduÄŸu iÃ§in silinmedi\n", count)
		}
	}

	// JobContractor kaydÄ±nÄ± sil - BaÅŸka iÅŸlerle iliÅŸkisi yoksa
	if relations.Edges.Contractor != nil {
		// Contractor'Ä±n baÅŸka iÅŸlerle iliÅŸkisi var mÄ± kontrol et
		count, err := tx.JobRelations.Query().
			Where(
				jobrelations.HasContractorWith(
					jobcontractor.IDEQ(relations.Edges.Contractor.ID),
				),
				jobrelations.YibfNoNEQ(yibfNo),
			).Count(txCtx)
		if err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("yÃ¼klenici iliÅŸkileri kontrol edilirken hata: %w", err)
		}

		if count == 0 {
			// BaÅŸka iliÅŸkisi yoksa sil
			if err := tx.JobContractor.DeleteOne(relations.Edges.Contractor).Exec(txCtx); err != nil {
				_ = tx.Rollback()
				return nil, fmt.Errorf("yÃ¼klenici kaydÄ± silinirken hata: %w", err)
			}
			fmt.Println("YÃ¼klenici kaydÄ± baÅŸarÄ±yla silindi")
		} else {
			fmt.Printf("YÃ¼klenici baÅŸka %d iÅŸ ile iliÅŸkili olduÄŸu iÃ§in silinmedi\n", count)
		}
	}

	// JobAuthor kaydÄ±nÄ± sil - Ä°ÅŸe Ã¶zel olduÄŸundan doÄŸrudan sil
	if relations.Edges.Author != nil {
		if err := tx.JobAuthor.DeleteOne(relations.Edges.Author).Exec(txCtx); err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("proje mÃ¼ellifi kaydÄ± silinirken hata: %w", err)
		}
		fmt.Println("Proje mÃ¼ellifi kaydÄ± baÅŸarÄ±yla silindi")
	}

	// JobSupervisor kaydÄ±nÄ± sil - BaÅŸka iÅŸlerle iliÅŸkisi yoksa
	if relations.Edges.Supervisor != nil {
		// Supervisor'Ä±n baÅŸka iÅŸlerle iliÅŸkisi var mÄ± kontrol et
		count, err := tx.JobRelations.Query().
			Where(
				jobrelations.HasSupervisorWith(
					jobsupervisor.IDEQ(relations.Edges.Supervisor.ID),
				),
				jobrelations.YibfNoNEQ(yibfNo),
			).Count(txCtx)
		if err != nil {
			_ = tx.Rollback()
			return nil, fmt.Errorf("ÅŸantiye ÅŸefi iliÅŸkileri kontrol edilirken hata: %w", err)
		}

		if count == 0 {
			// BaÅŸka iliÅŸkisi yoksa sil
			if err := tx.JobSupervisor.DeleteOne(relations.Edges.Supervisor).Exec(txCtx); err != nil {
				_ = tx.Rollback()
				return nil, fmt.Errorf("ÅŸantiye ÅŸefi kaydÄ± silinirken hata: %w", err)
			}
			fmt.Println("Åžantiye ÅŸefi kaydÄ± baÅŸarÄ±yla silindi")
		} else {
			fmt.Printf("Åžantiye ÅŸefi baÅŸka %d iÅŸ ile iliÅŸkili olduÄŸu iÃ§in silinmedi\n", count)
		}
	}

	// JobRelations kaydÄ±nÄ± sil
	if err := tx.JobRelations.DeleteOne(relations).Exec(txCtx); err != nil {
		_ = tx.Rollback()
		return nil, fmt.Errorf("iÅŸ iliÅŸkileri kaydÄ± silinirken hata: %w", err)
	}
	fmt.Println("Ä°ÅŸ iliÅŸkileri kaydÄ± baÅŸarÄ±yla silindi")

	// Transaction'Ä± commit et
	fmt.Println("Transaction commit ediliyor...")
	if err := tx.Commit(); err != nil {
		fmt.Printf("Transaction commit hatasÄ±: %v\n", err)
		return nil, fmt.Errorf("deÄŸiÅŸiklikler kaydedilirken hata: %w", err)
	}
	fmt.Println("Transaction baÅŸarÄ±yla commit edildi")

	// Silme iÅŸleminden sonra, aynÄ± YibfNo ile kayÄ±t olup olmadÄ±ÄŸÄ±nÄ± kontrol edelim
	// EÄŸer hala varsa, bu bir tutarsÄ±zlÄ±k durumudur ve dÃ¼zeltilmesi gerekir
	checkClient := middlewares.GetClientFromContext(ctx)
	if checkClient != nil {
		// JobDetail kontrolÃ¼
		exists, err := checkClient.JobDetail.Query().Where(jobdetail.YibfNo(yibfNo)).Exist(ctx)
		if err == nil && exists {
			fmt.Printf("UYARI: YibfNo=%d iÃ§in JobDetail kaydÄ± hala mevcut, zorla siliniyor...\n", yibfNo)
			// Zorla silme iÅŸlemi
			_, err = checkClient.JobDetail.Delete().Where(jobdetail.YibfNo(yibfNo)).Exec(ctx)
			if err != nil {
				fmt.Printf("JobDetail zorla silme hatasÄ±: %v\n", err)
			} else {
				fmt.Println("JobDetail kaydÄ± zorla silindi")
			}
		}

		// JobRelations kontrolÃ¼
		exists, err = checkClient.JobRelations.Query().Where(jobrelations.YibfNo(yibfNo)).Exist(ctx)
		if err == nil && exists {
			fmt.Printf("UYARI: YibfNo=%d iÃ§in JobRelations kaydÄ± hala mevcut, zorla siliniyor...\n", yibfNo)
			// Zorla silme iÅŸlemi
			_, err = checkClient.JobRelations.Delete().Where(jobrelations.YibfNo(yibfNo)).Exec(ctx)
			if err != nil {
				fmt.Printf("JobRelations zorla silme hatasÄ±: %v\n", err)
			} else {
				fmt.Println("JobRelations kaydÄ± zorla silindi")
			}
		}
	}

	return result, nil
}

// JobBatchQuery is the resolver for the jobBatchQuery field.
func (r *queryResolver) JobBatchQuery(ctx context.Context, yibfNo *int, state *string) ([]*model.JobBatchResult, error) {
	client := middlewares.GetClientFromContext(ctx)
	if client == nil {
		return nil, fmt.Errorf("client nil")
	}

	customClaim := middlewares.CtxValue(ctx)

	// KullanÄ±cÄ±nÄ±n ÅŸirketlerini al
	userCompanies, err := client.CompanyUser.Query().
		Where(companyuser.HasUserWith(user.IDEQ(customClaim.ID))).
		QueryCompany().
		All(ctx)
	if err != nil {
		return nil, fmt.Errorf("kullanÄ±cÄ± ÅŸirketleri alÄ±namadÄ±: %w", err)
	}

	// KullanÄ±cÄ±nÄ±n yetkili olduÄŸu ÅŸirket kodlarÄ±nÄ± topla
	var companyCodes []int
	for _, company := range userCompanies {
		companyCodes = append(companyCodes, company.CompanyCode)
	}

	// Query builder'Ä± baÅŸlat
	query := client.JobRelations.Query()

	// KullanÄ±cÄ±nÄ±n ÅŸirketlerine gÃ¶re filtrele
	query = query.Where(jobrelations.HasCompanyWith(companydetail.CompanyCodeIn(companyCodes...)))

	// State kontrolÃ¼ - state deÄŸeri "all" deÄŸilse bitmiÅŸleri ve fesihlileri gÃ¶sterme
	if state == nil || *state != "all" {
		excludedStates := []string{
			"BitmiÅŸ",
			"Fesihli Tespitli",
			"Ruhsat Redli (Ceza Sonucu)",
			"Fesihli Tespitsiz",
			"Fesihli Tespitsiz (Ceza Sebebiyle)",
			"Veri AktarÄ±mÄ± Bekleyen (Fesihli)",
			"Migrasyon Fesihli Eksik MÃ¼ellif",
			"KÄ±smi BitmiÅŸ",
		}
		query = query.Where(jobrelations.HasJobWith(jobdetail.StateNotIn(excludedStates...)))
	}

	// EÄŸer yibfNo belirtilmiÅŸse filtreleme yap
	if yibfNo != nil {
		query = query.Where(jobrelations.YibfNo(*yibfNo))
	}

	// Sadece gerekli iliÅŸkileri yÃ¼kle
	query = query.WithCompany().
		WithJob().
		WithOwner().
		WithContractor().
		WithAuthor().
		WithSupervisor().
		WithProgress().
		WithInspector().
		WithStatic().
		WithArchitect().
		WithMechanic().
		WithElectric().
		WithController().
		WithMechaniccontroller().
		WithElectriccontroller()

	// TÃ¼m kayÄ±tlarÄ± getir
	relations, err := query.All(ctx)
	if err != nil {
		return nil, fmt.Errorf("kayÄ±tlar aranÄ±rken hata oluÅŸtu: %w", err)
	}

	// SonuÃ§larÄ± dÃ¶nÃ¼ÅŸtÃ¼r
	var results []*model.JobBatchResult
	for _, relation := range relations {

		results = append(results, &model.JobBatchResult{
			Job:        relation.Edges.Job,
			Owner:      relation.Edges.Owner,
			Contractor: relation.Edges.Contractor,
			Author:     relation.Edges.Author,
			Supervisor: relation.Edges.Supervisor,
			Engineer: &model.JobEngineer{
				YibfNo:             &relation.YibfNo,
				Inspector:          relation.Edges.Inspector,
				Static:             relation.Edges.Static,
				Architect:          relation.Edges.Architect,
				Mechanic:           relation.Edges.Mechanic,
				Electric:           relation.Edges.Electric,
				Controller:         relation.Edges.Controller,
				MechanicController: relation.Edges.Mechaniccontroller,
				ElectricController: relation.Edges.Electriccontroller,
			},
			Progress: relation.Edges.Progress,
			Company:  relation.Edges.Company,
		})
	}

	if len(results) == 0 {
		if yibfNo != nil {
			return nil, fmt.Errorf("%d Yibf No iÃ§in kayÄ±t bulunamadÄ±", *yibfNo)
		}
		return []*model.JobBatchResult{}, nil
	}

	return results, nil
}
